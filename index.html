<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üèë Placar Bike Polo ‚Äî Web</title>
  <style>
    :root{
      --bg1:#111; --bg2:#181818; --panel:#202020; --txt:#eaeaea;
      --a:#1E40AF; --b:#B91C1C; --accent:#3b82f6; --danger:#ef4444;
      --gap:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:#000; color:var(--txt);
      font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      display:grid; grid-template-rows: 1fr 5fr auto; min-height:100svh;
    }
    header, footer{background:var(--bg1); padding:8px var(--gap); display:flex; align-items:center; justify-content:center}
    header{ position:relative; }
    .time{
      font-weight:800; text-align:center; background:var(--bg1); border-radius:16px; padding:8px 12px;
      font-size: clamp(32px, 8vw, 96px); cursor:text;
    }
    /* Editor inline do tempo */
    .time-input{
      position:absolute; left:50%; top:18px; transform:translateX(-50%);
      z-index:5; display:none; width:min(320px, 70vw); text-align:center;
      font-weight:800; font-size: clamp(28px, 7.5vw, 80px);
      padding:6px 12px; border-radius:12px; border:2px solid #3c6ac6;
      background:#161616; color:#eaeaea; outline:none;
    }

    .panel{background:var(--panel); border-radius:16px; padding:16px; display:flex; flex-direction:column; align-items:center}
    .title{opacity:.9; font-weight:700; margin-bottom:8px; font-size: clamp(16px, 2.5vw, 28px)}
    .title[contenteditable="true"]{outline:2px dashed transparent; border-radius:6px; padding:2px 6px; cursor:text}
    .title[contenteditable="true"]:focus{outline:2px dashed var(--accent); background:#262626}
    .score{font-weight:900; letter-spacing:1px; margin:0 0 12px; font-size: clamp(48px, 10vw, 120px)}
    .grid{ display:grid; gap:12px; }
    .grid.two{grid-template-columns: 1fr 1fr;}
    .grid.one{grid-template-columns: 1fr;}
    button{
      all:unset; cursor:pointer; user-select:none; text-align:center; border-radius:12px; padding:12px;
      background:#2b2b2b; color:#fff; font-weight:800; font-size: clamp(16px, 2.2vw, 24px);
      border:2px solid #333;
    }
    button:active{transform:translateY(1px)}
    .btn-big{padding:16px; font-size: clamp(20px, 2.6vw, 28px)}
    .btn-play{padding:18px; font-size: clamp(24px, 3vw, 32px)}
    .center .grid.one button{min-height:64px}
    footer{font-size:clamp(11px, 1.6vw, 14px); text-align:center}
    .tips{opacity:.85}

    /* √Åreas do grid */
    .panel.left  { grid-area: left; }
    .panel.center{ grid-area: center; }
    .panel.right { grid-area: right; }

    /* Desktop */
    main{
      background:var(--bg2);
      padding:var(--gap);
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-areas: "left center right";
      gap:var(--gap);
    }
    /* Mobile */
    @media (max-width: 900px){
      main{
        grid-template-columns: 1fr 1fr;
        grid-template-areas:
          "left  right"
          "center center";
      }
    }

    /* Resultados */
    .results-wrap{ width:100%; max-width:1200px; margin:0 auto; display:flex; flex-direction:column; gap:8px; }
    details.results{ background:#121212; border:1px solid #232323; border-radius:10px; padding:8px 12px; }
    details.results summary{cursor:pointer; font-weight:700}
    .result-item{
      display:grid; grid-template-columns: 1fr auto auto; align-items:center;
      gap:8px; padding:8px; border-radius:8px; background:#1b1b1b; margin-top:8px;
    }
    .result-item .meta{opacity:.9; font-size:14px}
    .result-item .actions button{ border-color:#333; padding:8px 12px; font-size:14px; margin-left:6px; }
    .actions .edit{background:#243b55}
    .actions .delete{background:#3a2323}

    /* Modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal{
      width:min(92vw, 560px); background:#1a1a1a; border:1px solid #2b2b2b; border-radius:14px; padding:16px;
      display:flex; flex-direction:column; gap:12px;
    }
    .modal h3{margin:0; font-size:20px}
    .form-row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .input{ background:#111; border:1px solid #333; color:#fff; padding:10px 12px; border-radius:10px; font-size:16px; width:100%; }
    .modal .btn-row{display:flex; justify-content:flex-end; gap:10px; margin-top:6px}
    .btn-outline{background:#202020; border:2px solid #333}
    .btn-primary{background:#284f99; border:2px solid #3c6ac6}
    .btn-danger{background:#6b2727; border:2px solid #8b2e2e}
    .small{font-size:12px; opacity:.8}
  </style>
</head>
<body>
  <header>
    <div id="time" class="time" title="Clique para editar o tempo">15:00</div>
    <input id="timeEdit" class="time-input" type="text" inputmode="numeric" pattern="[0-9:]*" aria-label="Editar tempo (MM:SS ou apenas n√∫meros)" />
  </header>

  <main>
    <section class="panel left">
      <div id="nameA" class="title" contenteditable="true" spellcheck="false">Equipe A</div>
      <div id="scoreA" class="score" style="color:var(--a)">0</div>
      <div class="grid two">
        <button class="btn-big" id="aPlus">+</button>
        <button class="btn-big" id="aMinus">‚àí</button>
      </div>
    </section>

    <section class="panel center">
      <div class="grid one" style="width:100%">
        <button id="plus30" class="btn-big">+ Tempo (+30s)</button>
        <button id="toggle" class="btn-play">‚ñ∂ / ‚è∏</button>
        <button id="minus30" class="btn-big">‚àí Tempo (‚àí30s)</button>
        <button id="reset" class="btn-big">‚ü≥ Reset (15:00)</button>
        <button id="finalize" class="btn-big" style="background:#2a3b24;border-color:#3c5a33">‚úÖ Finalizar/Salvar partida</button>
      </div>
    </section>

    <section class="panel right">
      <div id="nameB" class="title" contenteditable="true" spellcheck="false">Equipe B</div>
      <div id="scoreB" class="score" style="color:var(--b)">0</div>
      <div class="grid two">
        <button class="btn-big" id="bPlus">+</button>
        <button class="btn-big" id="bMinus">‚àí</button>
      </div>
    </section>
  </main>

  <footer>
    <div class="results-wrap">
      <div class="tips">
        Atalhos: Espa√ßo = start/pausa ‚Ä¢ R = reset ‚Ä¢ [ = ‚àí30s ‚Ä¢ ] = +30s ‚Ä¢ 1‚Üí00:20 ‚Ä¢ 2‚Üí01:00 ‚Ä¢ 3‚Üí02:00 ‚Ä¢ 5‚Üí05:00 ‚Ä¢ 0‚Üí10:00 ‚Ä¢ Q/W A‚àí/A+ ‚Ä¢ O/P B‚àí/B+
      </div>
      <details class="results" id="resultsBox">
        <summary>Resultados salvos (local)</summary>
        <div id="resultsList"></div>
      </details>
      <div class="small">Os resultados s√£o salvos no cache do navegador (localStorage) deste dispositivo.</div>
    </div>
  </footer>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <h3 id="modalTitle">Revisar e salvar partida</h3>
      <div class="form-row">
        <div>
          <label class="small">Time A</label>
          <input id="mNameA" class="input" type="text" />
        </div>
        <div>
          <label class="small">Placar A</label>
          <input id="mScoreA" class="input" type="number" min="0" />
        </div>
      </div>
      <div class="form-row">
        <div>
          <label class="small">Time B</label>
          <input id="mNameB" class="input" type="text" />
        </div>
        <div>
          <label class="small">Placar B</label>
          <input id="mScoreB" class="input" type="number" min="0" />
        </div>
      </div>
      <div>
        <label class="small">Observa√ß√µes (opcional)</label>
        <input id="mNotes" class="input" type="text" placeholder="ex.: gol no √∫ltimo segundo, revis√£o de √°rbitro, etc." />
      </div>
      <div class="btn-row">
        <button id="mCancel" class="btn-outline">Cancelar</button>
        <button id="mSave" class="btn-primary">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const GAME_DURATION = 15 * 60; // segundos
    const SOUND_URLS = {
      start: "assets/sounds/start.mp3",
      pause: "assets/sounds/pause.mp3",
      end:   "assets/sounds/end.mp3",
      m5:    "assets/sounds/5min.mp3",
      m1:    "assets/sounds/1min.mp3",
    };
    // Padr√µes extras (10:00 e 2:00) por s√≠ntese; remova se n√£o quiser
    const MILESTONES = { 600:'SS', 120:'SSS' };
    const LAST10_PATTERN = 'S';

    // ===== Estado =====
    let timeLeft = GAME_DURATION;
    let running = false;
    let scoreA = 0, scoreB = 0;
    let nameA = 'Equipe A', nameB = 'Equipe B';
    let eventsFired = new Set();
    let nextTick = performance.now() + 1000;
    let startPending = false;

    // ===== √ÅUDIO =====
    let audioCtx = null;
    const buffers = {};
    const beepQueue = [];
    let beeperBusy = false;

    function ensureAudio(){ if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
    async function fetchAsBuffer(url){ ensureAudio(); const res=await fetch(url,{cache:"force-cache"}); const arr=await res.arrayBuffer(); return await audioCtx.decodeAudioData(arr); }
    async function loadBuffer(key){ if (buffers[key]) return buffers[key]; const url=SOUND_URLS[key]; if (!url) return null; const buf=await fetchAsBuffer(url); buffers[key]=buf; return buf; }
    async function playBufferByKey(key){
      const buf = await loadBuffer(key);
      if (!buf) return 0;
      ensureAudio();
      const src = audioCtx.createBufferSource();
      src.buffer = buf;
      const gain = audioCtx.createGain(); gain.gain.value = 0.95;
      src.connect(gain).connect(audioCtx.destination);
      src.start();
      const ms = buf.duration*1000; await new Promise(r=>setTimeout(r, ms)); return ms;
    }
    // s√≠ntese fallback para padr√µes
    const BEEP_SHORT_FREQ=500, BEEP_LONG_FREQ=700, BEEP_SHORT_MS=500, BEEP_LONG_MS=900;
    async function playTone(freq, durMs){
      ensureAudio();
      const osc=audioCtx.createOscillator(), g=audioCtx.createGain();
      osc.type='sine'; osc.frequency.value=freq;
      g.gain.setValueAtTime(0.001,audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.3,audioCtx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+durMs/1000);
      osc.connect(g).connect(audioCtx.destination);
      osc.start(); await new Promise(r=>setTimeout(r,durMs)); osc.stop();
    }
    async function playPattern(pattern){
      if (!pattern) return;
      beepQueue.push(pattern);
      if (beeperBusy) return;
      beeperBusy = true;
      try{
        while(beepQueue.length){
          const pat = beepQueue.shift();
          for (let i=0;i<pat.length;i++){
            const short = pat[i].toUpperCase()==='S';
            await playTone(short?BEEP_SHORT_FREQ:BEEP_LONG_FREQ, short?BEEP_SHORT_MS:BEEP_LONG_MS);
            await new Promise(r=>setTimeout(r,120));
          }
        }
      }finally{ beeperBusy=false; }
    }

    // ===== Helpers/UI =====
    const $ = sel => document.querySelector(sel);
    function fmt(sec){
      sec = Math.max(0, Math.floor(sec));
      const m = String(Math.floor(sec/60)).padStart(2,'0');
      const s = String(sec%60).padStart(2,'0');
      return `${m}:${s}`;
    }
    function render(){
      $('#time').textContent = fmt(timeLeft);
      $('#scoreA').textContent = String(scoreA);
      $('#scoreB').textContent = String(scoreB);
      $('#nameA').textContent = nameA;
      $('#nameB').textContent = nameB;
    }
    function purgeFutureEvents(){
      eventsFired = new Set([...eventsFired].filter(e=>{
        if (typeof e === 'number') return e <= timeLeft;
        if (typeof e === 'string' && e.startsWith('last10_')) return timeLeft <= 10;
        return true;
      }));
      // console.log('[EVENTS]', eventsFired);
    }

    // ===== Resultados =====
    const LS_KEY='polo_matches_v1';
    function loadMatches(){ try{return JSON.parse(localStorage.getItem(LS_KEY))||[]}catch{return[]} }
    function saveMatches(list){ localStorage.setItem(LS_KEY, JSON.stringify(list)); }
    function addMatch(rec){ const l=loadMatches(); l.unshift(rec); saveMatches(l); renderResults(); }
    function updateMatch(id,patch){ const l=loadMatches(); const i=l.findIndex(x=>x.id===id); if(i>=0){ l[i]={...l[i],...patch,edited:true}; saveMatches(l); renderResults(); } }
    function deleteMatch(id){ saveMatches(loadMatches().filter(x=>x.id!==id)); renderResults(); }
    function renderResults(){
      const list=loadMatches(), c=$('#resultsList'); c.innerHTML='';
      if(!list.length){ c.innerHTML='<div class="small">Nenhum resultado salvo ainda.</div>'; return; }
      list.slice(0,20).forEach(rec=>{
        const row=document.createElement('div'); row.className='result-item';
        const when=new Date(rec.timestamp).toLocaleString();
        row.innerHTML=`
          <div>
            <div><strong>${rec.nameA}</strong> ${rec.scoreA} √ó ${rec.scoreB} <strong>${rec.nameB}</strong></div>
            <div class="meta">${when}${rec.edited?' ‚Ä¢ editado':''} ‚Ä¢ dura√ß√£o: ${fmt(rec.duration)}</div>
            ${rec.notes?`<div class="small">Obs.: ${rec.notes}</div>`:''}
          </div>
          <div class="actions"><button class="edit">Editar</button></div>
          <div class="actions"><button class="delete">Excluir</button></div>`;
        row.querySelector('.edit').addEventListener('click',()=>{
          openModal({id:rec.id,nameA:rec.nameA,nameB:rec.nameB,scoreA:rec.scoreA,scoreB:rec.scoreB,notes:rec.notes||'',duration:rec.duration},true);
        });
        row.querySelector('.delete').addEventListener('click',()=>{ if(confirm('Excluir este registro?')) deleteMatch(rec.id); });
        c.appendChild(row);
      });
    }

    // ===== Modal =====
    const modal=$('#modalBackdrop');
    const mNameA=$('#mNameA'), mNameB=$('#mNameB'), mScoreA=$('#mScoreA'), mScoreB=$('#mScoreB'), mNotes=$('#mNotes'), mCancel=$('#mCancel'), mSave=$('#mSave');
    let editingId=null; let currentDuration=GAME_DURATION;
    function openModal(data=null,isEditing=false){
      if(data){
        editingId=isEditing?data.id:null;
        mNameA.value=data.nameA??nameA; mNameB.value=data.nameB??nameB;
        mScoreA.value=data.scoreA??scoreA; mScoreB.value=data.scoreB??scoreB;
        mNotes.value=data.notes??''; currentDuration=data.duration??(GAME_DURATION-timeLeft);
      }else{
        editingId=null; mNameA.value=nameA; mNameB.value=nameB; mScoreA.value=scoreA; mScoreB.value=scoreB; mNotes.value=''; currentDuration=GAME_DURATION-timeLeft;
      }
      modal.style.display='flex'; mNameA.focus();
    }
    function closeModal(){ modal.style.display='none'; }
    mCancel.addEventListener('click', closeModal);
    modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });
    mSave.addEventListener('click', ()=>{
      const rec={
        id: editingId || crypto.randomUUID(),
        timestamp: Date.now(),
        nameA: mNameA.value.trim()||'Equipe A',
        nameB: mNameB.value.trim()||'Equipe B',
        scoreA: Math.max(0, parseInt(mScoreA.value||'0',10)),
        scoreB: Math.max(0, parseInt(mScoreB.value||'0',10)),
        duration: Math.max(0, parseInt(currentDuration||GAME_DURATION,10)),
        notes: mNotes.value.trim(),
        edited: !!editingId
      };
      if(editingId) updateMatch(editingId,rec); else addMatch(rec);
      closeModal();
    });

    // ===== A√ß√µes =====
    function changeScore(team,delta){ if(team==='A'){scoreA=Math.max(0,scoreA+delta);} else {scoreB=Math.max(0,scoreB+delta);} render(); }
    function changeTime(delta){ timeLeft=Math.max(0,timeLeft+delta); render(); purgeFutureEvents(); }
    function jumpTo(sec){ timeLeft = Math.max(0, Math.floor(sec)); render(); purgeFutureEvents(); } // <- corrigido

    async function toggle(){
      ensureAudio();
      if(running){
        running=false; playBufferByKey('pause'); console.log('[STATE] PAUSADO', fmt(timeLeft)); return;
      }
      if(startPending) return;
      startPending=true; console.log('[STATE] START PENDING‚Ä¶');
      const dur=await playBufferByKey('start');
      running=true; startPending=false; nextTick=performance.now()+1000;
      console.log('[STATE] INICIADO', fmt(timeLeft), `(start.mp3 ~${Math.round(dur)}ms)`);
    }
    function reset(){ running=false; timeLeft=GAME_DURATION; eventsFired.clear(); render(); console.log('[RESET] 15:00; eventos limpos.'); }

    // Nomes
    $('#nameA').addEventListener('input', e=>{ nameA=e.currentTarget.textContent.trim()||'Equipe A'; });
    $('#nameB').addEventListener('input', e=>{ nameB=e.currentTarget.textContent.trim()||'Equipe B'; });

    // ===== Editor de tempo (<input>) =====
    const timeEl=$('#time'); const timeEdit=$('#timeEdit');
    function parseTimeText(txt){
      if(!txt) return null; txt=String(txt).trim();
      if(txt.includes(':')){ const [mStr,sStr]=txt.split(':'); const m=Math.max(0,parseInt(mStr||'0',10)); const s=Math.max(0,parseInt(sStr||'0',10)); return m*60+s; }
      const digits=txt.replace(/\D/g,''); if(digits.length===0) return null;
      if(digits.length<=2) return parseInt(digits,10);
      const sec=parseInt(digits.slice(-2),10), min=parseInt(digits.slice(0,-2),10); return min*60+sec;
    }
    function openTimeEditor(){
      timeEdit.value = fmt(timeLeft);
      timeEdit.style.display='block';
      requestAnimationFrame(()=>{ timeEdit.focus(); timeEdit.setSelectionRange(0,timeEdit.value.length); });
    }
    function closeTimeEditor(commit){
      const wasVisible = timeEdit.style.display!=='none';
      timeEdit.style.display='none';
      if(commit && wasVisible){
        const val=parseTimeText(timeEdit.value);
        if(val!==null){ timeLeft=Math.max(0,val); purgeFutureEvents(); }
        render();
      }
    }
    timeEl.addEventListener('click', openTimeEditor);
    timeEdit.addEventListener('keydown', e=>{
      if(e.key==='Enter'){ e.preventDefault(); closeTimeEditor(true); }
      else if(e.key==='Escape'){ e.preventDefault(); closeTimeEditor(false); }
    });
    timeEdit.addEventListener('blur', ()=> closeTimeEditor(true));

    // ===== Rel√≥gio =====
    function clockLoop(){
      if(running && timeLeft>0){
        const now=performance.now();
        if(now>=nextTick){
          timeLeft=Math.max(0,timeLeft-1);
          render();

          // MP3 exatos
          if(timeLeft===300 && !eventsFired.has(300)){ playBufferByKey('m5'); eventsFired.add(300); }
          if(timeLeft===60  && !eventsFired.has(60 )){ playBufferByKey('m1'); eventsFired.add(60 ); }

          // Padr√µes extras
          if(MILESTONES[timeLeft] && !eventsFired.has(timeLeft)){ playPattern(MILESTONES[timeLeft]); eventsFired.add(timeLeft); }

          // √öltimos 10s
          if(timeLeft>0 && timeLeft<=10){
            const key=`last10_${timeLeft}`;
            if(!eventsFired.has(key) && LAST10_PATTERN){ playPattern(LAST10_PATTERN); eventsFired.add(key); }
          }

          // Fim
          if(timeLeft===0 && !eventsFired.has(0)){
            playBufferByKey('end'); eventsFired.add(0); running=false; openModal(); $('#resultsBox').open=true;
          }

          nextTick += 1000;
        }
      }
      requestAnimationFrame(clockLoop);
    }

    // ===== Teclado (ignora quando digitando) =====
    function isTypingTarget(el){ if(!el) return false; const t=el.tagName?.toLowerCase(); return t==='input'||t==='textarea'||el.isContentEditable; }
    $('#aPlus').addEventListener('click', ()=>changeScore('A', +1));
    $('#aMinus').addEventListener('click', ()=>changeScore('A', -1));
    $('#bPlus').addEventListener('click', ()=>changeScore('B', +1));
    $('#bMinus').addEventListener('click', ()=>changeScore('B', -1));
    $('#plus30').addEventListener('click', ()=>changeTime(+30));
    $('#minus30').addEventListener('click', ()=>changeTime(-30));
    $('#toggle').addEventListener('click', toggle);
    $('#reset').addEventListener('click', reset);
    $('#finalize').addEventListener('click', ()=>{ openModal(); $('#resultsBox').open = true; });

    window.addEventListener('keydown', e=>{
      if(isTypingTarget(e.target)) return;
      if(['F6','F7','F8','F9','F10','F11','F12'].includes(e.key) || (e.ctrlKey && e.key==='F12')) e.preventDefault();
      if(e.key===' '){ e.preventDefault(); toggle(); }
      else if(e.key==='r'||e.key==='R') reset();
      else if(e.key==='[') changeTime(-30);
      else if(e.key===']') changeTime(+30);
      else if(e.key==='q'||e.key==='Q') changeScore('A', -1);
      else if(e.key==='w'||e.key==='W') changeScore('A', +1);
      else if(e.key==='o'||e.key==='O') changeScore('B', -1);
      else if(e.key==='p'||e.key==='P') changeScore('B', +1);
      else if(e.key==='1') jumpTo(20);
      else if(e.key==='2') jumpTo(60);
      else if(e.key==='3') jumpTo(120);
      else if(e.key==='5') jumpTo(300);
      else if(e.key==='0') jumpTo(600);
    }, {passive:false});

    // init
    renderResults();
    render();
    requestAnimationFrame(clockLoop);
  </script>
</body>
</html>
